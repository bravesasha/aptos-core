// Copyright © Aptos Foundation
// Parts of the project are originally copyright © Meta Platforms, Inc.
// SPDX-License-Identifier: Apache-2.0

use move_binary_format::{access::ModuleAccess, CompiledModule};
use move_core_types::{
    identifier::{IdentStr, Identifier},
    language_storage::{ModuleId, TypeTag},
};
use serde::{Deserialize, Serialize};
use serde_json::Value;
use std::{collections::BTreeMap, str::FromStr};
use wasm_bindgen::prelude::*;

mod codegen;

#[wasm_bindgen]
/// Arguments for each function.
#[derive(Clone, Debug, Hash, Eq, PartialEq, Serialize, Deserialize)]
pub enum BatchArgumentType {
    Raw,
    Signer,
    PreviousResult,
}

#[wasm_bindgen]
#[derive(Clone, Debug, Hash, Eq, PartialEq, Serialize, Deserialize)]
pub struct PreviousResult {
    call_idx: u16,
    return_idx: u16,
    operation_type: ArgumentOperation,
}

#[wasm_bindgen]
/// Arguments for each function. Wasm bindgen only support C-style enum so use option to work around.
#[derive(Clone, Debug, Hash, Eq, PartialEq, Serialize, Deserialize)]
pub struct BatchArgument {
    ty: BatchArgumentType,
    raw: Option<Vec<u8>>,
    signer: Option<u16>,
    previous_result: Option<PreviousResult>,
}

#[wasm_bindgen]
#[derive(Clone, Debug, Hash, Eq, PartialEq, Serialize, Deserialize)]
pub enum ArgumentOperation {
    Move,
    Copy,
    Borrow,
    BorrowMut,
}

#[wasm_bindgen]
/// Call a Move entry function.
#[derive(Clone, Debug, Hash, Eq, PartialEq, Serialize, Deserialize)]
pub struct BatchedFunctionCall {
    module: ModuleId,
    function: Identifier,
    ty_args: Vec<TypeTag>,
    args: Vec<BatchArgument>,
}

#[wasm_bindgen]
pub struct BatchedFunctionCallBuilder {
    calls: Vec<BatchedFunctionCall>,
    num_signers: u16,
    modules: BTreeMap<ModuleId, CompiledModule>,
}

#[wasm_bindgen]
impl BatchedFunctionCallBuilder {
    fn num_of_returns(&self, module_id: &ModuleId, func_name: &IdentStr) -> anyhow::Result<u16> {
        if let Some(module) = self.modules.get(module_id) {
            for def in module.function_defs() {
                let handle = module.function_handle_at(def.function);
                if module.identifier_at(handle.name) == func_name {
                    return Ok(module.signature_at(handle.return_).0.len() as u16);
                }
            }
        }
        anyhow::bail!("{}::{} doesn't exist on chain", module_id, func_name)
    }

    pub fn single_signer() -> Self {
        Self {
            calls: vec![],
            num_signers: 1,
            modules: BTreeMap::new(),
        }
    }

    pub fn multi_signer(signer_count: u16) -> Self {
        Self {
            calls: vec![],
            num_signers: signer_count,
            modules: BTreeMap::new(),
        }
    }

    fn add_batched_call_impl(
        &mut self,
        module: String,
        function: String,
        ty_args: Vec<String>,
        args: Vec<BatchArgument>,
    ) -> anyhow::Result<Vec<BatchArgument>> {
        self.calls.push(BatchedFunctionCall {
            module: ModuleId::from_str(&module)?,
            function: Identifier::new(function.clone())?,
            ty_args: ty_args
                .iter()
                .map(|s| TypeTag::from_str(s))
                .collect::<anyhow::Result<Vec<_>>>()?,
            args,
        });
        let return_count = self.num_of_returns(
            &ModuleId::from_str(&module)?,
            &Identifier::new(function.clone())?,
        )?;
        Ok((0..return_count)
            .into_iter()
            .map(|return_idx| BatchArgument {
                ty: BatchArgumentType::PreviousResult,
                raw: None,
                signer: None,
                previous_result: Some(PreviousResult {
                    call_idx: self.calls.len() as u16,
                    return_idx,
                    operation_type: ArgumentOperation::Move,
                }),
            })
            .collect())
    }

    pub fn add_batched_call(
        &mut self,
        module: String,
        function: String,
        ty_args: Vec<String>,
        args: Vec<BatchArgument>,
    ) -> Result<Vec<BatchArgument>, JsValue> {
        self.add_batched_call_impl(module, function, ty_args, args)
            .map_err(|err| JsValue::from(format!("{:?}", err)))
    }

    pub fn generate_batched_calls(self) -> Result<Vec<u8>, JsValue> {
        crate::codegen::generate_script_from_batched_calls(
            &self.calls,
            self.num_signers,
            &self.modules,
        )
        .map_err(|err| JsValue::from(format!("{:?}", err)))
    }

    async fn load_module_impl(
        &mut self,
        api_url: String,
        module_name: String,
    ) -> anyhow::Result<()> {
        let module_id = ModuleId::from_str(&module_name).unwrap();
        let url = format!(
            "{}/{}/{}/{}/{}",
            api_url,"accounts",&module_id.address,"module",&module_id.name
        );
        let response = reqwest::get(url).await?;
        let result = if response.status().is_success() {
            Ok(response.text().await?)
        } else {
            Err(response.text().await?)
        };

        let bytes_result = match result {
            Ok(json_string) => {
                let v: Value = serde_json::from_str(&json_string)?;
                Ok(v["bytecode"].to_string())
            },
            Err(json_string) => {
                let v: Value = serde_json::from_str(&json_string)?;
                Err(v["message"].to_string())
            },
        };

        match bytes_result {
            Ok(bytes_hex) => {
                self.modules.insert(
                    module_id,
                    CompiledModule::deserialize(hex::decode(bytes_hex.replace("0x", "").replace("\"", ""))?.as_slice())?,
                );
                Ok(())
            },
            Err(message) => Ok(()),
        }
    }

    pub async fn load_module(
        &mut self,
        api_url: String,
        module_name: String,
    ) -> Result<(), JsValue> {
        self.load_module_impl(api_url, module_name)
            .await
            .map_err(|err| JsValue::from(format!("{:?}", err)))
    }
}

#[wasm_bindgen]
impl BatchArgument {
    pub fn new_bytes(bytes: Vec<u8>) -> Self {
        Self {
            ty: BatchArgumentType::Raw,
            raw: Some(bytes),
            signer: None,
            previous_result: None,
        }
    }

    pub fn new_signer(signer_idx: u16) -> Self {
        Self {
            ty: BatchArgumentType::Signer,
            raw: None,
            signer: Some(signer_idx),
            previous_result: None,
        }
    }

    pub fn borrow(&self) -> Result<BatchArgument, JsValue> {
        self.change_op_type(ArgumentOperation::Borrow)
    }

    pub fn borrow_mut(&self) -> Result<BatchArgument, JsValue> {
        self.change_op_type(ArgumentOperation::BorrowMut)
    }

    pub fn copy(&self) -> Result<BatchArgument, JsValue> {
        self.change_op_type(ArgumentOperation::Copy)
    }

    fn change_op_type(&self, operation_type: ArgumentOperation) -> Result<BatchArgument, JsValue> {
        match (&self.ty, &self.previous_result) {
            (
                BatchArgumentType::PreviousResult,
                Some(PreviousResult {
                    call_idx,
                    return_idx,
                    operation_type: _,
                }),
            ) => Ok(BatchArgument {
                ty: BatchArgumentType::PreviousResult,
                raw: None,
                signer: None,
                previous_result: Some(PreviousResult {
                    call_idx: *call_idx,
                    return_idx: *return_idx,
                    operation_type,
                }),
            }),
            _ => Err(JsValue::from_str(
                "Unexpected argument type, can only borrow from previous function results",
            )),
        }
    }
}


#[cfg(test)]
mod tests{
    use move_binary_format::CompiledModule;

    
    #[test]
    fn test(){
        let i = "0xa11ceb0b060000000f0100240224620386019803049e043805d604bc03079208f51108871a2006a71a870510ae1fd7110a853185010b8a32040c8e32aa100db842140ecc42040fd0420c0006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180c00001904010001001a0600001b0600001c0600001d0800001e0600001f02000020020000210300002206000023020000240300092b0600063b040106010c5207010000105307000f57040203010001045d07000b5d0700045e07000b5e070000250001000026020300002702040000280203000029050300002a020600002c070800002d090600002e0a0200002f0b03000030020c0000310201000032020d0000330202000034020d0000350b02000036020200003702040000380704000039020c00003a020c00003c070e0106003d0f0400003e0f0400003f02040100004007040000410704000042050400004305040000441004000045090400004609040000471104000048120400004913040102045f01150004600116000461180c010205620d0d0004631901000b5f011a000b60011b000b611c0c01020b631d010005640d0d0003090203000165200101000966220800063c080e01060c670425010005680d0d000d690702000c6a290c0100056b0d0d00056c0d0d000c6d2d0c0100056e0d0d000c6f2e25010011702f0401000a7101010008720102000c732d0c01000c742d2001000e750704000f76043302030402770421000c7836250100107904390100067a3a0401060c7b3b2e0100057c0d0d000f6a400c0203000f7d41420203000f7e4304020300077f040c000680012e04010625172a172e023023302431023402370239023a213d023e024032302e25352a3542022238432e442345024732483249324b444424252e2a2e04020a020a02060809010a020105010c0002060c05020c080a01060c01080d02060c0a020206050a020106080a01010103010b0e01090005060c0a02020a020507060c020a02020a020a020a0205060c05020a020a0203050708000a020505020a020a020900050a0208120813081408150108120108140108090306081406081209000106081201081301081503060815060813090001060813020101050a020b0e010802030b0e0108040c01060900010202050703010802010804010b0f01090001080601080a020608000502060b0f0109000609000b0101010101010101010c080a0307080005080d07050c0608000708000c05080a01060b0f01090001090002070a09000a090001060800010703020505010b11020900090109070800050a020a020808081208130814081501080802070b0f010900090002080c0501080c01081002070b0e010900090001070b0f01090009070800050809050a020a02081208130a02020708000506080905050a020608000708000405070b11020505050502060b110209000901090002070b110209000901090001090103070b11020900090109000901010803070708000a020a0208120813081408150d6170746f735f6163636f756e7404636f696e0767656e65736973106d756c74697369675f6163636f756e74107265736f757263655f6163636f756e74167472616e73616374696f6e5f76616c69646174696f6e076163636f756e740362637308636861696e5f69640d6372656174655f7369676e65720765643235353139056572726f72056576656e740866656174757265730866726f6d5f626373046775696404686173680d6d756c74695f65643235353139066f7074696f6e067369676e65721073797374656d5f616464726573736573057461626c6509747970655f696e666f06766563746f72074163636f756e740f4361706162696c6974794f6666657211436f696e52656769737465724576656e740b4b6579526f746174696f6e104b6579526f746174696f6e4576656e74124f726967696e6174696e674164647265737312526f746174696f6e4361706162696c69747925526f746174696f6e4361706162696c6974794f6666657250726f6f664368616c6c656e676527526f746174696f6e4361706162696c6974794f6666657250726f6f664368616c6c656e6765563216526f746174696f6e50726f6f664368616c6c656e6765105369676e65724361706162696c697479235369676e65724361706162696c6974794f6666657250726f6f664368616c6c656e6765255369676e65724361706162696c6974794f6666657250726f6f664368616c6c656e67655632366173736572745f76616c69645f726f746174696f6e5f70726f6f665f7369676e61747572655f616e645f6765745f617574685f6b65790e6372656174655f6163636f756e74206372656174655f6163636f756e745f69665f646f65735f6e6f745f6578697374186372656174655f6163636f756e745f756e636865636b6564186372656174655f617574686f72697a65645f7369676e6572216372656174655f6672616d65776f726b5f72657365727665645f6163636f756e7404475549440b6372656174655f67756964176372656174655f7265736f757263655f6163636f756e74176372656174655f7265736f757263655f616464726573731d6372656174655f7369676e65725f776974685f6361706162696c697479096578697374735f6174166765745f61757468656e7469636174696f6e5f6b65791a6765745f677569645f6e6578745f6372656174696f6e5f6e756d216765745f726f746174696f6e5f6361706162696c6974795f6f666665725f666f72136765745f73657175656e63655f6e756d6265721d6765745f7369676e65725f6361706162696c6974795f616464726573731f6765745f7369676e65725f6361706162696c6974795f6f666665725f666f7219696e6372656d656e745f73657175656e63655f6e756d6265720a696e697469616c697a651e69735f726f746174696f6e5f6361706162696c6974795f6f6666657265641c69735f7369676e65725f6361706162696c6974795f6f6666657265640b4576656e7448616e646c65106e65775f6576656e745f68616e646c65196f666665725f726f746174696f6e5f6361706162696c697479176f666665725f7369676e65725f6361706162696c6974790d72656769737465725f636f696e1e7265766f6b655f616e795f726f746174696f6e5f6361706162696c6974791c7265766f6b655f616e795f7369676e65725f6361706162696c6974791a7265766f6b655f726f746174696f6e5f6361706162696c697479187265766f6b655f7369676e65725f6361706162696c69747919726f746174655f61757468656e7469636174696f6e5f6b65791e726f746174655f61757468656e7469636174696f6e5f6b65795f63616c6c22726f746174655f61757468656e7469636174696f6e5f6b65795f696e7465726e616c32726f746174655f61757468656e7469636174696f6e5f6b65795f776974685f726f746174696f6e5f6361706162696c6974792d7570646174655f617574685f6b65795f616e645f6f726967696e6174696e675f616464726573735f7461626c65157665726966795f7369676e65645f6d6573736167651261757468656e7469636174696f6e5f6b65790f73657175656e63655f6e756d62657211677569645f6372656174696f6e5f6e756d14636f696e5f72656769737465725f6576656e7473136b65795f726f746174696f6e5f6576656e747319726f746174696f6e5f6361706162696c6974795f6f66666572177369676e65725f6361706162696c6974795f6f6666657203666f72064f7074696f6e0854797065496e666f166f6c645f61757468656e7469636174696f6e5f6b6579166e65775f61757468656e7469636174696f6e5f6b65790b616464726573735f6d6170055461626c6511726563697069656e745f616464726573730e736f757263655f616464726573730a6f726967696e61746f721063757272656e745f617574685f6b65790e6e65775f7075626c69635f6b657914556e76616c6964617465645075626c69634b6579095369676e6174757265256e65775f756e76616c6964617465645f7075626c69635f6b65795f66726f6d5f6279746573186e65775f7369676e61747572655f66726f6d5f6279746573197369676e61747572655f7665726966795f7374726963745f7410696e76616c69645f617267756d656e742c756e76616c6964617465645f7075626c69635f6b65795f746f5f61757468656e7469636174696f6e5f6b65790e616c72656164795f65786973747308746f5f627974657306637265617465046e6f6e65096e6f745f666f756e640a616464726573735f6f6608636f6e7461696e73117065726d697373696f6e5f64656e6965640c6f75745f6f665f72616e67650769735f6e6f6e650d696e76616c69645f737461746504736f6d6506617070656e6408736861335f3235360a746f5f616464726573730769735f736f6d6506626f72726f77166173736572745f6170746f735f6672616d65776f726b036e6577036765740c737761705f6f725f66696c6c07747970655f6f660a656d69745f6576656e7407657874726163740f756e61757468656e746963617465640672656d6f7665036164641e6d6f64756c655f6576656e745f6d6967726174696f6e5f656e61626c656404656d697400000000000000000000000000000000000000000000000000000000000000010201ff030801000000000000000308100000000000000003080200000000000000030805000000000000000201000308140000000000000003080a0000000000000003080d000000000000000308080000000000000003080c000000000000000308040000000000000003080900000000000000030813000000000000000308120000000000000003080e0000000000000003080b00000000000000030811000000000000000308060000000000000003080f000000000000000308030000000000000003080700000000000000030800000000000004000410ffffffffffffffff00000000000000000201010a0221200000000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000000105200000000000000000000000000000000000000000000000000000000000000003052000000000000000000000000000000000000000000000000000000000000000020520000000000000000000000000000000000000000000000000000000000000000405200000000000000000000000000000000000000000000000000000000000000005052000000000000000000000000000000000000000000000000000000000000000060520000000000000000000000000000000000000000000000000000000000000000705200000000000000000000000000000000000000000000000000000000000000008052000000000000000000000000000000000000000000000000000000000000000090520000000000000000000000000000000000000000000000000000000000000000a126170746f733a3a6d657461646174615f7631c2111500000000000000000e454432353531395f534348454d4564536368656d65206964656e74696669657220666f722045643235353139207369676e617475726573207573656420746f206465726976652061757468656e7469636174696f6e206b65797320666f722045643235353139207075626c6963206b6579732e010000000000000017454143434f554e545f414c52454144595f455849535453164163636f756e7420616c726561647920657869737473020000000000000017454143434f554e545f444f45535f4e4f545f4558495354164163636f756e7420646f6573206e6f742065786973740300000000000000184553455155454e43455f4e554d4245525f544f4f5f4249473353657175656e6365206e756d626572206578636565647320746865206d6178696d756d2076616c756520666f7220612075363404000000000000001d454d414c464f524d45445f41555448454e5449434154494f4e5f4b4559355468652070726f76696465642061757468656e7469636174696f6e206b65792068617320616e20696e76616c6964206c656e6774680500000000000000184543414e4e4f545f52455345525645445f414444524553533143616e6e6f7420637265617465206163636f756e742062656361757365206164647265737320697320726573657276656406000000000000000b454f55545f4f465f4741532a5472616e73616374696f6e2065786365656465642069747320616c6c6f6361746564206d6178206761730700000000000000194557524f4e475f43555252454e545f5055424c49435f4b45592b5370656369666965642063757272656e74207075626c6963206b6579206973206e6f7420636f727265637408000000000000001b45494e56414c49445f50524f4f465f4f465f4b4e4f574c45444745535370656369666965642070726f6f66206f66206b6e6f776c6564676520726571756972656420746f2070726f7665206f776e657273686970206f662061207075626c6963206b657920697320696e76616c696409000000000000000e454e4f5f4341504142494c495459535468652063616c6c657220646f6573206e6f7420686176652061206469676974616c2d7369676e61747572652d6261736564206361706162696c69747920746f2063616c6c20746869732066756e6374696f6e0a000000000000002345494e56414c49445f4143434550545f524f544154494f4e5f4341504142494c495459515468652063616c6c657220646f6573206e6f74206861766520612076616c696420726f746174696f6e206361706162696c697479206f666665722066726f6d20746865206f74686572206163636f756e740b0000000000000024454e4f5f56414c49445f4652414d45574f524b5f52455345525645445f41444452455353454164647265737320746f20637265617465206973206e6f7420612076616c6964207265736572766564206164647265737320666f72204170746f73206672616d65776f726b0c000000000000000f45494e56414c49445f534348454d45810153706563696669656420736368656d6520726571756972656420746f2070726f6365656420776974682074686520736d61727420636f6e7472616374206f7065726174696f6e202d2063616e206f6e6c7920626520454432353531395f534348454d45283029204f52204d554c54495f454432353531395f534348454d452831290d000000000000001c45494e56414c49445f4f524947494e4154494e475f414444524553536c41626f727420746865207472616e73616374696f6e20696620746865206578706563746564206f726967696e6174696e67206164647265737320697320646966666572656e742066726f6d20746865206f726967696e6174696e672061646472657373206f6e2d636861696e0e000000000000001a454e4f5f535543485f5349474e45525f4341504142494c4954593e546865207369676e6572206361706162696c697479206f6666657220646f65736e27742065786973742061742074686520676976656e20616464726573730f0000000000000019455245534f555243455f414343434f554e545f4558495354533c416e20617474656d707420746f206372656174652061207265736f75726365206163636f756e74206f6e206120636c61696d6564206163636f756e74100000000000000015454143434f554e545f414c52454144595f5553454456416e20617474656d707420746f206372656174652061207265736f75726365206163636f756e74206f6e20616e206163636f756e74207468617420686173206120636f6d6d6974746564207472616e73616374696f6e11000000000000001f454f4646455245525f414444524553535f444f45535f4e4f545f45584953541d4f666665726572206164647265737320646f65736e2774206578697374120000000000000022454e4f5f535543485f524f544154494f4e5f4341504142494c4954595f4f46464552565468652073706563696669656420726f746174696f6e2063617061626c697479206f6666657220646f6573206e6f742065786973742061742074686520737065636966696564206f666665726572206164647265737313000000000000001d454e4f5f5349474e45525f4341504142494c4954595f4f4646455245440014000000000000001f4545584345454445445f4d41585f475549445f4352454154494f4e5f4e554d00010b4b6579526f746174696f6e01040008096578697374735f6174010100136765745f73657175656e63655f6e756d626572010100166765745f61757468656e7469636174696f6e5f6b65790101001a6765745f677569645f6e6578745f6372656174696f6e5f6e756d0101001c69735f7369676e65725f6361706162696c6974795f6f6666657265640101001e69735f726f746174696f6e5f6361706162696c6974795f6f6666657265640101001f6765745f7369676e65725f6361706162696c6974795f6f666665725f666f72010100216765745f726f746174696f6e5f6361706162696c6974795f6f666665725f666f720101000002074a0a024b034c034d0b0e0108024e0b0e0108044f0b01010806500b0101080a010201510b0f01050202011608100302030605540a02550a02040202540a02550a02050201560b1102050506020106050702024b03580508020408024b03590558050902044b035a055b055c0a020a020106050b02024b0358050c02034b0359055805012601270000000014360a0007052104180b0111230c050b0211240c070e070e050b031438000411051407091126270e0511270c0405340b00071821042c0b0111280c060b0211290c080e080e060b031438010429053107091126270b0301070a1126270e06112b0c040b0402010300001e250a00290020040505080701112c270a00071a2204110a00071b220c010513090c010b01041a0a00071c220c02051c090c020b02041f052207041126270b001103020201000004080a0029002004070b0011010102030000001f290a00112d0c050e0038020c010e01412106200000000000000021040c050f070b1126270600000000000000000c030a000d03112f38030c020b000d03112f38040c040e050b010600000000000000000b030b020b04380539003805390112002d000b05020401000100281c0a01110a040405090b000107111132270a012b000c020b0011330c030b02100037000e03380604160519070f1132270b01112d02050300002a620a00071b210407080c01050b0a00071d210c010b010410080c0205140a00071c210c020b020419080c03051d0a00071e210c030b030422080c0405260a00071f210c040b04042b080c05052f0a000720210c050b050434080c0605380a000721210c060b06043d080c0705410a000722210c070b070446080c08054a0a000723210c080b08044f080c0905530a000724210c090b090456055907101135270a0011030c0a0b00120a0c0b0b0a0b0b0206010001002b170b0011330c020a022a000c010b020a010f02112f0c030b011002140716230412051507061136270b030207010001002c3d0b0011330c020e020b0111080c070a07110a04260a072b000c040a04100037003807041305180b04010713112c270b0410031406000000000000000021041f052207021138270a07112d0c0305290a0711030c030b030c060e060719111f0a072a000c050a0738080b050f003600150b07120a0c080b060b080208010000010d0b0038020c020d020b0138090d02070044210b02113b113c020901000004050b00100414112d020a01000004030b002900020b0100010004050b002b00100514020c0100010004050b002b00100214020d0100010030140b002b000c010a0110063701380a0409050e0b0101070d1132270b0110063701380b14020e0100010004050b002b00100314020f01000004040b0010041402100100010030140b002b000c010a0110003700380a0409050e0b0101070d1132270b0110003700380b1402110300010031170b002a000f030c010a011435071723040b05100b010107141136270a0114060100000000000000160b0115021203000004070a00113f0b00380c12052d0502130100010004060b002b0010063701380a02140100010004060b002b0010003700380a02150100010004040b001106380d021601040100346a0b0011330c060a04110a0407050a07031132270a062a000c0511410a051003140b060a0412080c090a02070521043a0b0311230c0a0e0a11270c070a051005140b07210426052b0b050107151126270b0111240c0c0e0c0e0a0b09380e043405390b0501070911262705630b02071821045e0b0311280c0b0e0b112b0c080a051005140b0821044b05500b050107151126270b0111290c0d0e0d0e0b0b09380f045905630b050107091126270b0501070a1126270b050f0636010b04381001021701040100371e0b0011330c060a04110a0407050a07031132270a06110e0a060a04120c0c050a060b020b030b010b0538110b062a000f0036000b0438100102180300010004070b002a000f0738121202381302190104010004080b0011332a000f063601381401021a0104010004080b0011332a000f003600381401021b01040100041a0a01110a040405090b000107031132270a0011332a00100637010e013806041205170b0001070e1132270b001119021c01040100041a0a01110a040405090b000107031132270a0011332a00100037000e013806041205170b0001070f1132270b00111a021d01040200053c5d0b0011330c080a08110a0407050a07031132270a082a000c070a0107052104240a0211230c0d0e0d11270c0b0a071005140b0b21041e05230b07010715114627053f0a01071821043a0a0211280c0e0e0e112b0c0c0a071005140b0c210435053f0b070107151146270b0701070a1126270a07100514113c0c0a0a071003140a080b0a0a0412090c090b010b020b050e091100010b030b040b060e0911000c0f0b080b070b0f1121021e0004010004040b000b01111f021f030001003d1b0b0011330c030a03110a0407050a07031132270e0141210620000000000000002104100513070b1126270b032a000c020b010b020f0515022001040200053e350a01110a040405090b000107111132270b0011330c070a012b000c090a09100637010e0738060416051b0b0901070e1132270b09100514113c0c060b07110e0a010b060a0312090c050b020b030b040e0511000c080a012a000c0a0b010b0a0b0811210221000001053f3b071b2a050f080c040a01100514113c0c050a040a050c032e0b033815041e0a000a040b053816210417051e0b04010b010107081132270a02113c0c060b040b060a003817114a042e0b000a011005140a02120338180a010f090a011005140a02120438190b020b010f0515022201000100454a0b002a000c050a0107052104240b0211230c080e0811270c060b051005140b06210414051707151126270b0311240c0a0e0a0e080b04381a04200523070911262705490b0107182104440b0211280c090e09112b0c070b051005140b07210435053807151126270b0311290c0b0e0b0e090b04381b0441054907091126270b0501070a1126270200060100000200010a00000000050003050000040127012600000001000200030004000500";
        CompiledModule::deserialize(hex::decode(i.to_string().replace("0x", "")).unwrap().as_slice()).unwrap();
    }
}
